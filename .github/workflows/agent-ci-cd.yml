name: Agent CI/CD

on:
  push:
    branches: ["master"]
  workflow_dispatch: {}

env:
  # 仅使用阿里云 ACR（国内服务器拉取更快更稳）
  # 需要在 GitHub Secrets 配置：ACR_REGISTRY / ACR_NAMESPACE / ACR_USERNAME / ACR_PASSWORD
  IMAGE_NAME: ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/agent
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/apps/stack' }}
  COMPOSE_DST: ${{ secrets.COMPOSE_FILE || 'docker-compose.yml' }}
  SERVICE_NAME: ${{ secrets.AGENT_SERVICE_NAME || 'agent' }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image_tag: ${{ steps.vars.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Check required secrets
        run: |
          set -euo pipefail
          missing=0
          [ -n "${ACR_REGISTRY:-}" ] || { echo "[FATAL] missing secret: ACR_REGISTRY"; missing=1; }
          [ -n "${ACR_USERNAME:-}" ] || { echo "[FATAL] missing secret: ACR_USERNAME"; missing=1; }
          [ -n "${ACR_PASSWORD:-}" ] || { echo "[FATAL] missing secret: ACR_PASSWORD"; missing=1; }
          if [ "$missing" = "1" ]; then
            echo "\nPlease set these in: GitHub Repo -> Settings -> Secrets and variables -> Actions"
            exit 1
          fi
        env:
          ACR_REGISTRY: ${{ env.ACR_REGISTRY }}
          ACR_USERNAME: ${{ env.ACR_USERNAME }}
          ACR_PASSWORD: ${{ env.ACR_PASSWORD }}

      # 登录阿里云 ACR：用于 push agent 镜像
      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      - name: Compute image tag (Beijing time)
        id: vars
        run: |
          # 强制北京时间（Asia/Shanghai）生成 tag：YYYY-MM-DD-HHMM，例如 2026-01-12-1718
          TAG=$(TZ=Asia/Shanghai date +%Y-%m-%d-%H%M)
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT

      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -e

            # 将本次构建生成的镜像 tag 传入远端（ssh-action 不会自动传递 job env）
            IMAGE_TAG='${{ needs.build-and-push.outputs.image_tag }}'
            echo "[deploy] IMAGE_TAG=${IMAGE_TAG}"

            # 登录阿里云 ACR（增加重试，避免偶发网络抖动导致失败）
            for i in 1 2 3; do
              echo "[deploy] docker login ${{ secrets.ACR_REGISTRY }} (try ${i}/3)"
              if echo "${{ secrets.ACR_PASSWORD }}" | docker login "${{ secrets.ACR_REGISTRY }}" -u "${{ secrets.ACR_USERNAME }}" --password-stdin; then
                break
              fi
              if [ "$i" = "3" ]; then
                echo "[deploy][FATAL] docker login ACR failed after 3 attempts"
                exit 1
              fi
              sleep $((i * 3))
            done

            cd "${{ env.DEPLOY_PATH }}"

            if [ -f "${{ env.COMPOSE_DST }}" ]; then
              # 1) 清理任意形如 <...> 的编辑器/系统标记（不仅仅是 user__selection）
              sed -i -E 's#<[^>]+>##g' "${{ env.COMPOSE_DST }}" || true

              # 2) 常见被污染的 YAML key 兜底修复：services:/logging:/tags: 等冒号后被拼接了脏内容
              sed -i -E 's#^(\s*services):.*#\1:#' "${{ env.COMPOSE_DST }}" || true
              sed -i -E 's#^(\s*logging):.*#\1:#' "${{ env.COMPOSE_DST }}" || true
              sed -i -E 's#^(\s*tags):.*\|#\1: |#' "${{ env.COMPOSE_DST }}" || true

              # 3) 打印一次 config 校验（失败时输出关键行，便于定位）
              if ! docker compose -f "${{ env.COMPOSE_DST }}" config >/dev/null 2>&1; then
                echo "[deploy][FATAL] docker compose config failed, showing lines 45-75 of ${COMPOSE_DST}:"
                nl -ba "${{ env.COMPOSE_DST }}" | sed -n '45,75p' || true
                exit 1
              fi
            fi

            # 若端口被旧容器占用，先清理（仅清理绑定了 8001 的容器）
            OCC=$(docker ps --format '{{.ID}} {{.Ports}}' | awk '/:8001->/ {print $1}')
            [ -n "$OCC" ] && docker rm -f $OCC || true

            # 将 compose 中 agent 镜像固定到本次构建的时间戳 tag
            sed -i -E "s#(^[[:space:]]*image:[[:space:]]*).*/agent:.*#\\1${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/agent:${IMAGE_TAG}#" "${{ env.COMPOSE_DST }}"

            docker compose -f "${{ env.COMPOSE_DST }}" pull "${{ env.SERVICE_NAME }}"
            docker compose -f "${{ env.COMPOSE_DST }}" up -d --remove-orphans "${{ env.SERVICE_NAME }}"

            docker system prune -f
